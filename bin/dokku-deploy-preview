#!/bin/sh -l
set -e

if [ -n "$PLUGIN_REVIEW_APP_NAME" ]; then
  export REVIEW_APP_NAME="$PLUGIN_REVIEW_APP_NAME"
fi

source helpers/app

DOKKU_CMD='ssh -p "$ssh_port" "dokku@$ssh_host"'

setup-ssh

log-info "Creating Dokku preview deployment"

ssh_port=$(parse-ssh-port)
ssh_host=$(parse-ssh-host)

commit_sha="$(parse-ci-commit)"

app-ensure ${REVIEW_APP_NAME}

# TODO Set app config
# TODO Check for require plugin
## TODO Create services
## TODO Link services
# TODO Deploy application
# TODO Check for Letsencrypt plugin
## TODO Enable Letsencrypt

ssh -p "$ssh_port" "dokku@$ssh_host" apps:unlock "$app"

